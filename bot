from telegram import Update
from telegram.ext import ApplicationBuilder, CommandHandler, ContextTypes, MessageHandler, filters
from dotenv import load_dotenv
import os


load_dotenv()
token = ("BOT_TOKEN")  # ‚úÖ —Ç–µ–ø–µ—Ä—å –∏–∑ .env

app = ApplicationBuilder().token(token).build()

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–∂–µ—Ç —Ç–µ–±–µ –Ω–∞–π—Ç–∏ —Ñ–∏–ª—å–º –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏ /poisc –∏–ª–∏ /info –µ—Å–ª–∏ —Ö–æ—á–µ—à—å —É–∑–Ω–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏  .")

async def poisc(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.message.text.strip()
    link = f"https://kinogo.biz/index.php?do=search&subaction=search&story={query.replace(' ', '+')}"
    history = context.user_data.get("history", [])
    history.append(query)
    context.user_data["history"] = history
    await update.message.reply_text(f"üîç –í–æ—Ç, —á—Ç–æ –Ω–∞—à—ë–ª:\n{link}")

async def info(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("–º–æ–≥—É –ø–æ—Å–æ–≤–µ—Ç–æ–≤–∞—Ç—å —Ñ–∏–ª—å–º /favorit_cinema\n –º–æ–≥—É –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Ñ–∏–ª—å–º–∞ /istoria ")

async def favorit_cinema(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("–æ–±–∏—Ç–µ–ª—å –∑–ª–∞ https://kinogo.biz/18403-obitel-zla.html\n—Ç—Ä–µ—Ç–∏–π –ª–∏—à–Ω–∏–π https://kinogo.biz/25452-tretij-lishnij.html\n  –∏–Ω—Ç–µ—Ä—Å—Ç–µ–ª–ª–∞—Ä https://kinogo.biz/17487-interstellar.html")

async def istoria(update: Update, context: ContextTypes.DEFAULT_TYPE):
    history = context.user_data.get("history", [])
    if not history:
        await update.message.reply_text("–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π –Ω–∞–π—Ç–∏ —á—Ç–æ-—Ç–æ —á–µ—Ä–µ–∑ /poisc")
    else:
        text = "üïò –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ñ–∏–ª—å–º—ã:\n" + "\n".join(f"- {item}" for item in history[-3:])
        await update.message.reply_text(text)


# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, poisc))
app.add_handler(CommandHandler("start", start))
app.add_handler(CommandHandler("info", info))
app.add_handler(CommandHandler("favorit_cinema", favorit_cinema))
app.add_handler(CommandHandler("istoria", istoria))


app.run_polling()
